import telebot
from config import keys, TOKEN
from extensions import APIException, CurrencyConverter


bot = telebot.TeleBot(TOKEN, parse_mode='HTML')


@bot.message_handler(commands=['start'])
def start(message: telebot.types.Message):
    bot.send_message(message.chat.id, f'–ü—Ä–∏–≤–µ—Ç, {message.chat.username}!\n\n'
                                      f'‚Ä¢ –≠—Ç–æ—Ç –±–æ—Ç —É–º–µ–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—ã. –ß—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å, –≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É –≤'
                                      f' —Ñ–æ—Ä–º–∞—Ç–µ:\n'
                                      f'<b>—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)<b>–≤–æ_—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)'
                                      f'<b>—Å–∫–æ–ª—å–∫–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>\n\n'
                                      f'‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç –¥–ª—è <i>"—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏"</i> –∏ <i>"–≤–æ_—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏"</i> –ø–∏—à–∏'
                                      f' –≤ —Ñ–æ—Ä–º–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–∂–∞.\n'
                                      f'‚Ä¢ –ò —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã.\n'
                                      f'‚Ä¢ –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç—ã ‚Äî –Ω–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π <i>—Ç–æ—á–∫—É</i> –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è'
                                      f' –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏.\n\n'
                                      f'‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞–ª—é—Ç: /values\n(–≤ –æ–±—â–µ–º, –ø–∏—Å–∞—Ç—å –≤–∞–ª—é—Ç—ã '
                                      f'–Ω—É–∂–Ω–æ —Ç–∞–∫, –∫–∞–∫ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ /values)\n'
                                      f'‚Ä¢ –í—ã–∑–≤–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∫–æ–º–∞–Ω–¥—ã: /help\n'
                                      f'‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç: /start\n'
                                      f'‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞—Ç–µ–ª—è –±–æ—Ç–∞: /comment')


@bot.message_handler(commands=['help'])
def help(message: telebot.types.Message):
    text = '<b>‚Ä¢ –ö–∞–∫ –≤–≤–æ–¥–∏—Ç—å –∫–æ–º–∞–Ω–¥—É? ‚Ä¢</b>\n\n' \
           '<b>—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)<b>–≤–æ_—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)<b>—Å–∫–æ–ª—å–∫–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>\n' \
           '–ù–∞–ø—Ä–∏–º–µ—Ä: <i>—Ä—É–±–ª—å –µ–≤—Ä–æ 85700</i>\n\n' \
           '<b>‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–≤–æ–¥–∞ ‚Ä¢</b>\n\n' \
           '1. –ù–∞–∑–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç –¥–ª—è <i>"—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏"</i> –∏ <i>"–≤–æ_—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏"</i> –ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞' \
           ' –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–∂–∞.\n' \
           '2. –ò —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã.\n' \
           '3. –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç—ã ‚Äî –Ω–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π <i>—Ç–æ—á–∫—É</i> –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏.\n\n' \
           '‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞–ª—é—Ç: /values\n(–≤ –æ–±—â–µ–º, –ø–∏—Å–∞—Ç—å –≤–∞–ª—é—Ç—ã ' \
           '–Ω—É–∂–Ω–æ —Ç–∞–∫, –∫–∞–∫ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ /values)\n' \
           '‚Ä¢ –í—ã–∑–≤–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É: /help (–≤ –Ω–µ–π –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è üôÉ)\n' \
           '‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç: /start\n' \
           '‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞—Ç–µ–ª—è –±–æ—Ç–∞: /comment'
    bot.reply_to(message, text)


@bot.message_handler(commands=['values'])
def values(message: telebot.types.Message):
    text = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–ª—é—Ç—ã:'
    for key in keys.keys():
        text = '\n‚Ä¢ '.join((text, key, ))
    bot.reply_to(message, text)


@bot.message_handler(commands=['comment'])
def comment(message: telebot.types.Message):
    text = '"–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –ø–æ –û–û–ü", —Å—É—Ç—å –∫–æ—Ç–æ—Ä–æ–≥–æ ‚Äî –ø–µ—Ä–µ–ø–µ—á–∞—Ç–∞—Ç—å –∫–æ–¥ –∏–∑ –≤–∏–¥–µ–æ –∏ –∑–∞–º–µ–Ω–∏—Ç—å –≤ –Ω—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ ‚Äî ' \
           '—ç—Ç–æ, –∫–æ–Ω–µ—á–Ω–æ, —Å–∏–ª—å–Ω–æ. –ù–æ —Å–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å —ç—Ç–æ–π –¥–æ–º–∞—à–∫–æ–π –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–µ –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è üôä\n' \
           '–ë—É–¥—É —Ä–∞–¥–∞ —É–∑–Ω–∞—Ç—å, —á—Ç–æ –±—ã–ª –∫–∞–∫–æ–π-—Ç–æ –ø–æ–¥–≤–æ—Ö, –∫–æ—Ç–æ—Ä—ã–π —è –Ω–µ –∑–∞–º–µ—Ç–∏–ª–∞, –∏ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å–ª–æ–∂–Ω–µ–µ)'
    bot.reply_to(message, text)


@bot.message_handler(content_types=['text', ])
def convert(message: telebot.types.Message):
    try:
        values = message.text.split(' ')

        if len(values) != 3:
            raise APIException('–ù–µ —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤. –í–æ–∑–º–æ–∂–Ω–æ, —Ç—ã –≤–≤—ë–ª –ª–∏—à–Ω–∏–π –ø—Ä–æ–±–µ–ª –∏–ª–∏ –Ω–∞—Ä—É—à–∏–ª '
                               '—Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞:\n'
                               '<b>—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)<b>–≤–æ_—á—Ç–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>(–ø—Ä–æ–±–µ–ª)<b>—Å–∫–æ–ª—å–∫–æ_–ø–µ—Ä–µ–≤–µ—Å—Ç–∏</b>')

        base, quote, amount = values
        total_base = CurrencyConverter.get_price(base, quote, amount)
    except APIException as e:
        bot.reply_to(message, f'–û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n{e}')
    except Exception as e:
        bot.reply_to(message, f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É.\n{e}')
    else:
        text = f"–¶–µ–Ω–∞ {amount} {base} –≤ {quote} ‚Äî {'{:0.4f}'.format(total_base)}"
        # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–∏ –≤–≤–æ–¥–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —á–∏—Å–ª–æ –≤ –ø—Ä–∏–≤—ã—á–Ω–æ–º, –∞ –Ω–µ –≤
        # —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏. –ß–µ–º –±—ã –Ω–∏ —Ç–µ—à–∏–ª—Å—è, –ª–∏—à—å –±—ã –Ω–µ –≤–æ–∑–º—É—â–∞–ª—Å—è, —á—Ç–æ –±–æ—Ç –µ–º—É —á—Ç–æ-—Ç–æ –Ω–µ —Ç–æ –≤—ã–¥–∞—ë—Ç.
        # –ü—Ä–∏ —ç—Ç–æ–º –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        # "0.0000", —Ö–æ—Ç—è –≥–¥–µ-—Ç–æ –¥–∞–ª—å—à–µ –∏ –±—É–¥—É—Ç –∑–Ω–∞—á–∞—â–∏–µ —Ü–∏—Ñ—Ä—ã - –Ω–æ —ç—Ç–æ—Ç –Ω–æ–ª—å –ø–æ —Å—É—Ç–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∞–≤–¥–æ–π. –ü–æ—ç—Ç–æ–º—É
        # –ø—É—Å—Ç—å –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–∞–∫, –ø–æ–∫–∞ —è –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª–∞, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ª—É—á—à–µ :)
        bot.send_message(message.chat.id, text)


bot.polling()
