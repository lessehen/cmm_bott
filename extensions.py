import requests
import json
from config import keys


class APIException(Exception):
    pass


'''
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ, —Ü–∏—Ç–∏—Ä—É—é –∑–∞–¥–∞–Ω–∏–µ:
"–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –æ–ø–∏—Å–∞—Ç—å –∫–ª–∞—Å—Å —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –º–µ—Ç–æ–¥–æ–º get_price(), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç—Ä–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞: 
1. –∏–º—è –≤–∞–ª—é—Ç—ã, —Ü–µ–Ω—É –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ —É–∑–Ω–∞—Ç—å, ‚Äî base, (—á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º)
2. –∏–º—è –≤–∞–ª—é—Ç—ã, —Ü–µ–Ω—É –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞–¥–æ —É–∑–Ω–∞—Ç—å, ‚Äî quote, (–≤–æ —á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º)
3. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ–π –≤–∞–ª—é—Ç—ã ‚Äî amount 
–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω—É–∂–Ω—É—é —Å—É–º–º—É –≤ –≤–∞–ª—é—Ç–µ".
–ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–ª–∞ –ø—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏ quote –∏ base –∏–∑ –∫–æ–¥–∞, –¥–∞–Ω–Ω–æ–≥–æ –≤ —Å–∫—Ä–∏–Ω–∫–∞—Å—Ç–µ ‚òª
'''


class CurrencyConverter:
    @staticmethod
    def get_price(base: str, quote: str, amount: str):

        if base == quote:
            raise APIException(f'–ó–∞—á–µ–º –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å {base} –≤ {quote}? –ü–æ–ª—É—á–∏—Ç—Å—è {amount}, –Ω–æ —ç—Ç–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ –±–µ–∑ –º–µ–Ω—è. '
                               f'–ü–æ–ø—Ä–æ–±—É–π –ø–æ-–¥—Ä—É–≥–æ–º—É :)')

        try:
            base_ticker = keys[base]
        except KeyError:
            raise APIException(f'–ù–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞–ª—é—Ç—É "{base}". –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –æ—à–∏–±–æ–∫ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ '
                               f'–ª–∏ —ç—Ç–∞ –≤–∞–ª—é—Ç–∞ –≤ /values.')

        try:
            quote_ticker = keys[quote]
        except KeyError:
            raise APIException(f'–ù–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞–ª—é—Ç—É "{quote}". –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –æ—à–∏–±–æ–∫ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ '
                               f'–ª–∏ —ç—Ç–∞ –≤–∞–ª—é—Ç–∞ –≤ /values.')

        if amount == '0':
            raise APIException(f'–¢—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Ö–æ—á–µ—à—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 0 {base}?\n'
                               f'–ï—Å–ª–∏ –¥–∞, —Ç–æ –±—É–¥–µ—Ç 0 üôÉ\n'
                               f'–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É –∑–∞–Ω–æ–≤–æ.')

        if amount[0] == '0' and '.' not in amount:
            raise APIException(f'–í–≤–µ–¥—ë–Ω–Ω–æ–µ —Ç–æ–±–æ–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å <i>0</i>. –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –ª–∏ —Ç—ã —Ü–∏—Ñ—Ä—É '
                               f'–∏–ª–∏ —Ç–æ—á–∫—É –∏–ª–∏ –≤–≤–µ–¥–∏ —á–∏—Å–ª–æ <i>{amount}</i> –±–µ–∑ –Ω—É–ª–µ–π –≤ –Ω–∞—á–∞–ª–µ.')

        try:
            amount = float(amount)
        except ValueError:
            raise APIException(f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "{amount}".\n'
                               f'–ü—Ä–∞–≤–∏–ª–∞ –≤–≤–æ–¥–∞: /values')

        if amount < 0:
            raise APIException(f'–£–≤—ã, –Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ —è –Ω–µ —É–º–µ—é. –ü–æ–ø—Ä–æ–±—É–π —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ.')

        r = requests.get(f'https://min-api.cryptocompare.com/data/price?fsym={base_ticker}&tsyms={quote_ticker}')
        total_base = float(json.loads(r.content)[keys[quote]])*amount
        # –¢–æ –ª–∏ —è –Ω–µ–≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–º–æ—Ç—Ä–µ–ª–∞, —Ç–æ –ª–∏ –≤ —Å–∫—Ä–∏–Ω–∫–∞—Å—Ç–µ –∑–∞–±—ã–ª–∏ —É–º–Ω–æ–∂–∏—Ç—å –∫—É—Ä—Å –≤–∞–ª—é—Ç—ã –Ω–∞ amount.

        return total_base
